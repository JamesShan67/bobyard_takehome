<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .add-comment { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px; font-size: 14px; resize: vertical; min-height: 100px; }
        .form-group textarea:focus { outline: none; border-color: #3498db; }
        .btn { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; margin-right: 10px; }
        .btn:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #229954; }
        .comments-list { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .comment { padding: 20px; border-bottom: 1px solid #e1e8ed; }
        .comment:last-child { border-bottom: none; }
        .comment-header { display: flex; align-items: center; margin-bottom: 10px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #e1e8ed; }
        .comment-info { flex: 1; }
        .comment-author { font-weight: 600; color: #2c3e50; margin-bottom: 2px; }
        .comment-date { font-size: 12px; color: #7f8c8d; }
        .comment-text { margin: 10px 0; color: #555; line-height: 1.6; }
        .comment-actions { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
        .comment-likes { display: flex; align-items: center; gap: 5px; color: #7f8c8d; font-size: 14px; }
        .edit-form { display: none; margin-top: 15px; }
        .edit-form.active { display: block; }
        .edit-form textarea { width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px; font-size: 14px; resize: vertical; min-height: 80px; }
        .edit-actions { display: flex; gap: 10px; margin-top: 10px; }
        .loading { text-align: center; padding: 20px; color: #7f8c8d; }
        .error { background: #e74c3c; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #27ae60; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>comment</h1>
        </div>

        <div class="add-comment">
            <form id="addCommentForm">
                <div class="form-group">
                    <textarea id="commentText" name="text" placeholder="write a comment" required></textarea>
                </div>
                <button type="submit" class="btn btn-success">add comment</button>
            </form>
        </div>

        <div id="message"></div>

        <div class="comments-list">
            <div id="loading" class="loading">Loading comments...</div>
            <div id="comments"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3002/api';
        let comments = [];

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => { messageDiv.innerHTML = ''; }, 3000);
        }

        async function fetchComments() {
            try {
                const response = await fetch(`${API_BASE_URL}/comments/`);
                if (!response.ok) throw new Error('Failed to fetch comments');
                comments = await response.json();
                renderComments();
            } catch (error) {
                console.error('Error fetching comments:', error);
                showMessage('Failed to load comments', 'error');
            }
        }

        async function addComment(text) {
            try {
                console.log('Attempting to add comment:', text);
                console.log('API URL:', `${API_BASE_URL}/comments/`);
                
                const response = await fetch(`${API_BASE_URL}/comments/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Failed to add comment: ${response.status} ${errorText}`);
                }
                
                const newComment = await response.json();
                console.log('New comment created:', newComment);
                comments.unshift(newComment);
                renderComments();
                showMessage('Comment added!');
            } catch (error) {
                console.error('Error adding comment:', error);
                showMessage('Failed to add comment', 'error');
            }
        }

        async function updateComment(id, text) {
            try {
                const response = await fetch(`${API_BASE_URL}/comments/${id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                if (!response.ok) throw new Error('Failed to update comment');
                const updatedComment = await response.json();
                const index = comments.findIndex(c => c.id === id);
                if (index !== -1) {
                    comments[index] = updatedComment;
                    renderComments();
                }
                showMessage('Comment updated!');
            } catch (error) {
                console.error('Error updating comment:', error);
                showMessage('Failed to update comment', 'error');
            }
        }

        async function deleteComment(id) {
            if (!confirm('Delete this comment?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/comments/${id}/`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete comment');
                comments = comments.filter(c => c.id !== id);
                renderComments();
                showMessage('Comment deleted!');
            } catch (error) {
                console.error('Error deleting comment:', error);
                showMessage('Failed to delete comment', 'error');
            }
        }

        function renderComments() {
            const commentsDiv = document.getElementById('comments');
            const loadingDiv = document.getElementById('loading');
            
            loadingDiv.style.display = 'none';
            
            if (comments.length === 0) {
                commentsDiv.innerHTML = '<div class="loading">No comments yet. Be the first to comment!</div>';
                return;
            }

            commentsDiv.innerHTML = comments.map(comment => `
                <div class="comment" data-id="${comment.id}">
                    <div class="comment-header">
                        <img src="${getAvatarUrl(comment)}" alt="${comment.author}" class="comment-avatar">
                        <div class="comment-info">
                            <div class="comment-author">${comment.author || 'Admin'}</div>
                            <div class="comment-date">${formatDate(comment.created_at)}</div>
                        </div>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="comment-actions">
                        <div class="comment-likes">
                            <span>like</span>
                            <span>${comment.likes}</span>
                        </div>
                        <button class="btn" onclick="startEdit(${comment.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteComment(${comment.id})">Delete</button>
                    </div>
                    <div class="edit-form" id="edit-form-${comment.id}">
                        <textarea id="edit-text-${comment.id}" placeholder="Edit your comment...">${comment.text}</textarea>
                        <div class="edit-actions">
                            <button class="btn btn-success" onclick="saveEdit(${comment.id})">Save</button>
                            <button class="btn" onclick="cancelEdit(${comment.id})">Cancel</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getAvatarUrl(comment) {
            if (comment.image && comment.image.url) {
                return comment.image.url;
            }
            return `https://via.placeholder.com/40x40/e1e8ed/7f8c8d?text=${(comment.author || 'A').charAt(0).toUpperCase()}`;
        }

        function startEdit(id) {
            const editForm = document.getElementById(`edit-form-${id}`);
            const editText = document.getElementById(`edit-text-${id}`);
            editForm.classList.add('active');
            editText.focus();
        }

        function cancelEdit(id) {
            const editForm = document.getElementById(`edit-form-${id}`);
            editForm.classList.remove('active');
        }

        function saveEdit(id) {
            const editText = document.getElementById(`edit-text-${id}`);
            const newText = editText.value.trim();
            
            if (!newText) {
                showMessage('Comment text cannot be empty', 'error');
                return;
            }
            
            updateComment(id, newText);
            cancelEdit(id);
        }

        document.getElementById('addCommentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('commentText').value.trim();
            
            if (!text) {
                showMessage('Please enter a comment', 'error');
                return;
            }
            
            await addComment(text);
            document.getElementById('addCommentForm').reset();
        });

        fetchComments();
    </script>
</body>
</html>
